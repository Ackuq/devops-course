name: Task dashboard generator

on:
    pull_request:
        types: [closed]

jobs:
    generate-dashboard:
        if: github.event.pull_request.merged == 'true'
        name: Generate dashboard
        runs-on: ubuntu-20.04
        steps:
            - uses: actions/checkout@v2.3.4
              with:
                  ref: 2021

            - name: Use Node LTS
              uses: actions/setup-node@v2.1.5
              with:
                  node-version: 12.18.3

            - name: Generate dashboard
              run: node contributions/course-automation/axp-chrigu/generateDashboard.js

            - name: Push new dashboard
              run: |
                  git config --global user.name 'Dashboard bot'
                  git config --global user.email 'dashboard-bot@users.noreply.github.com'
                  git add contributions/course-automation/axp-chrigu/dashboard.md
                  git commit -m "Generated dashboard"
                  git push

            - name: Comment on PR
              uses: actions/github-script@v3.1.0
              if: github.event_name == 'pull_request'
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
                      github.issues.createComment({ issue_number, owner, repo, body: 'You're task has been added to the dashboard' });
